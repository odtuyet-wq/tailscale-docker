name: Deploy PocketBase with Tailscale

on:
  workflow_dispatch: # Kích hoạt thủ công từ GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      TAILSCALE_CLIENT_SECRET: ${{ secrets.TAILSCALE_CLIENT_SECRET }}
      TAILSCALE_CLIENT_ID: ${{ secrets.TAILSCALE_CLIENT_ID }}

    steps:
      # Bước 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v2

      # Bước 2: Tạo thư mục data (nếu chưa có)
      - name: Create data directory
        run: |
          mkdir -p data  # Tạo thư mục data nếu nó chưa tồn tại

      # Bước 3: Cài đặt Docker Buildx (nếu cần)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      # Bước 4: Xây dựng và chạy Docker container
      - name: Build and run Docker container
        run: |
          docker build -t pocketbase-with-tailscale .
          docker run -d --cap-add=NET_ADMIN -p 8080:8080 --name pocketbase-with-tailscale \
            -e TAILSCALE_CLIENT_SECRET=your_tailscale_client_secret \
            -e TAILSCALE_CLIENT_ID=your_tailscale_client_id \
            -v $(pwd)/data:/pb_data \
            pocketbase-with-tailscale

      # Bước 5: Lấy IP Tailscale từ logs
      - name: Get Tailscale IP
        run: |
          docker logs pocketbase-with-tailscale
      - name: ⏳ Keep Alive
        run: |
          npx --yes @ongtrieuhau861457/runner-keep-alive --interval 60 --services All
